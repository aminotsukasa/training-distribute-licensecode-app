version: 1
applications:
  - backend:
    phases:
      preBuild:
        commands:
          - yum install jq -y
          - python3 -m pip install --upgrade --user cfn-lint aws-sam-cli
      build:
        commands:
          - amplifyPush --simple
          - export DEPLOYMENT_BUCKET_NAME=$(jq -r '.providers.awscloudformation.DeploymentBucketName' ./amplify/#current-cloud-backend/amplify-meta.json)
          - cd backend
          - sam deploy --s3-bucket $DEPLOYMENT_BUCKET_NAME
  - frontend:
    phases:
      preBuild:
        commands:
          - ApiUri=$(aws cloudformation describe-stacks --stack-name training-distribute-code-app --query 'Stacks[*].Outputs[?OutputKey==`ApiUri`].OutputValue' --output text)
          - sed -e "s|replace_your_api_url|$ApiUri|" src/config.js.org > src/config.js
          - npm install
      build:
        commands:
          - npm run build
      artifacts:
        baseDirectory: build
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
    appRoot: frontend
