version: 0.1
backend:
  phases:
    preBuild:
      commands:
        - npm install -g @aws-amplify/cli@latest
        - yum install jq -y
        - python3 -m pip install --upgrade --user cfn-lint aws-sam-cli
    build:
      commands:
        - "# Execute Amplify CLI with the helper script"
        - amplifyPush --simple
        ##
        # Extract Environment data
        ##
        - export DEPLOYMENT_BUCKET_NAME=$(jq -r '.providers.awscloudformation.DeploymentBucketName' ./amplify/#current-cloud-backend/amplify-meta.json)
        # Deploy Backend with SAM
        - cd backend
        - sam deploy --s3-bucket $DEPLOYMENT_BUCKET_NAME
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        # Setting ApiUri to config.js 
        - ApiUri=$(aws cloudformation describe-stacks --stack-name training-distribute-code-app --query 'Stacks[*].Outputs[?OutputKey==`ApiUri`].OutputValue' --output text)
        - sed -e "s|replace_your_api_url|$ApiUri|" src/config.js.org > src/config.js
        - npm install
    build:
      commands:
        - cd frontend
        - npm run build
  artifacts:
    baseDirectory: frontend/build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - frontend/node_modules/**/*
